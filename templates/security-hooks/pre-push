#!/usr/bin/env bash
# Security Pre-Push Hook
# Prevents sensitive information from being pushed to remote
# Version: 1.0.0

set -e

# Sensitive patterns to check for
SENSITIVE_EMAIL="steele.thompson13@gmail.com"
PLACEHOLDER_EMAIL="YOUR_EMAIL@example.com"

# Files to check (exclude backups and build artifacts)
FILES_TO_CHECK=$(git diff --cached --name-only --diff-filter=ACM | \
    grep -v "^backups/" | \
    grep -v "^.build-artifacts/" | \
    grep -v "^.git/" | \
    grep -v "^.jj/" | \
    grep -v "^.repomix/" || true)

if [ -z "$FILES_TO_CHECK" ]; then
    exit 0
fi

# Check for sensitive email in staged files
FOUND_SENSITIVE=false

for file in $FILES_TO_CHECK; do
    if [ -f "$file" ]; then
        if grep -q "$SENSITIVE_EMAIL" "$file" 2>/dev/null; then
            echo "⚠️  SECURITY WARNING: Sensitive email found in $file"
            FOUND_SENSITIVE=true
        fi
    fi
done

if [ "$FOUND_SENSITIVE" = true ]; then
    echo ""
    echo "❌ Push blocked: Sensitive information detected"
    echo ""
    echo "Found: $SENSITIVE_EMAIL"
    echo "Expected: $PLACEHOLDER_EMAIL"
    echo ""
    echo "Please run the email sanitization script:"
    echo "  python3 .build-artifacts/sanitize_email.py"
    echo ""
    echo "Or manually replace the email with the placeholder."
    echo ""
    exit 1
fi

exit 0
