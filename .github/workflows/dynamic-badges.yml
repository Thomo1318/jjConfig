name: Update Dynamic Badges

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Project Version (e.g. v1.1.0)"
        required: false
      jj_version:
        description: "Jujutsu Version (e.g. 0.23.0+)"
        required: false
        default: "0.23.0+"

jobs:
  update-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Update Badges (Gist)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GIST_ID: e766526dd2d577b808dc24e114e1cd0b
          VERSION: ${{ github.event.release.tag_name || github.event.inputs.version }}
          JJ_VERSION: ${{ github.event.inputs.jj_version }}
        run: |
          # Fallback logic
          if [ -z "$VERSION" ]; then VERSION="v1.1.0+"; fi
          if [ -z "$JJ_VERSION" ]; then JJ_VERSION="0.23.0+"; fi

          # Create JSON payloads
          echo "{\"schemaVersion\":1,\"label\":\"Release\",\"message\":\"$VERSION\",\"color\":\"blue\"}" > version.json
          echo "{\"schemaVersion\":1,\"label\":\"jj\",\"message\":\"$JJ_VERSION\",\"color\":\"purple\"}" > jj.json

          # Update Gist
          gh gist edit "$GIST_ID" -d "jjConfig Dynamic Badges (Updated: $(date))" version.json
          # Handle jj.json: use --add equivalent by specifying file mapping
          gh gist edit "$GIST_ID" -a jj.json || gh gist edit "$GIST_ID" -f jj.json jj.json

          echo "Updated Gist $GIST_ID with version $VERSION and jj $JJ_VERSION"
