#!/bin/sh
# GitGuardian Hook (pre-push)
# Scans commits for secrets before pushing to remote

# Check if ggshield is installed
if ! command -v ggshield >/dev/null 2>&1; then
	echo "‚ö†Ô∏è  ggshield not found in PATH"
	echo "   Skipping secret scan (install with 'brew install ggshield')"
	exit 0
fi

# Check if user is authenticated (fast check)
if ! ggshield quota >/dev/null 2>&1; then
	echo "‚ö†Ô∏è  ggshield not authenticated"
	echo "   Run 'ggshield auth login' to enable secret scanning"
	exit 0
fi

echo "üõ°Ô∏è  Scanning for secrets (GitGuardian)..."

# Scan commits being pushed
# $1 = remote name, $2 = remote URL
# Input format: <local_ref> <local_sha> <remote_ref> <remote_sha>
while read local_ref local_sha remote_ref remote_sha; do
	echo "üîç Scanning pus${: $local_}re${ ($local_}sha) ${> $remote_}re${ ($remote_}sha)"

	if [ "${local_sha}" = "0000000000000000000000000000000000000000" ]; then
		echo "‚ÑπÔ∏è  Deletion detected, skipping scan."
		continue
	fi

	if [ "${remote_sha}" = "0000000000000000000000000000000000000000" ]; then
		# New branch - scan all commits (fallback to HEAD^1 for safety if just one commit)
		echo "üÜï New branch detected. Scanning HEAD."
		# Use HEAD~1 if it exists, otherwise just HEAD
		if git rev-parse HEAD~1 >/dev/null 2>&1; then
			RANGE="HEAD~1..HEAD"
		else
			RANGE="HEAD"
		fi

		# In pre-push, for a new branch, we might want to scan all commits unique to this branch
		# But for new repo, HEAD works.
		ggshield secret scan commit-range "${RANGE}" || exit 1
	else
		# Scan range
		echo "üîÑ Scanning commit rang${: $remote_}sh${..$local_}sha"
		ggshield secret scan commit-range "${remote_sha}..${local_sha}" || exit 1
	fi
done

exit 0
