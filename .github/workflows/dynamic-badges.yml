name: Update Dynamic Badges

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Project Version (e.g. v1.1.0)"
        required: false
      jj_version:
        description: "Jujutsu Version (e.g. 0.23.0+)"
        required: false
        default: "0.23.0+"

jobs:
  update-badges:
    runs-on: ubuntu-latest
    steps:
      - name: Update Badges (Gist)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GIST_ID: e766526dd2d577b808dc24e114e1cd0b
          VERSION: ${{ github.event.release.tag_name || github.event.inputs.version }}
          JJ_VERSION: ${{ github.event.inputs.jj_version }}
        run: |
          # Fallback logic
          if [ -z "$VERSION" ]; then VERSION="v1.1.0+"; fi
          if [ -z "$JJ_VERSION" ]; then JJ_VERSION="0.23.0+"; fi

          # Create JSON content strings
          VERSION_JSON="{\"schemaVersion\":1,\"label\":\"Release\",\"message\":\"$VERSION\",\"color\":\"blue\"}"
          JJ_JSON="{\"schemaVersion\":1,\"label\":\"jj\",\"message\":\"$JJ_VERSION\",\"color\":\"purple\"}"

          # Construct API payload securely with jq
          # We update description and files in one go
          jq -n \
            --arg desc "jjConfig Dynamic Badges (Updated: $(date))" \
            --arg v "$VERSION_JSON" \
            --arg j "$JJ_JSON" \
            '{description: $desc, files: {"version.json": {content: $v}, "jj.json": {content: $j}}}' > payload.json

          # Update Gist via API
          curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/gists/$GIST_ID" \
            -d @payload.json

          echo "Updated Gist $GIST_ID with version $VERSION and jj $JJ_VERSION"
